<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Home - Asisten Fisika Lab 2</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-init.js"></script>
    <script type="module" src="theme.js"></script>
    <script type="module">
    import { initNightMode } from './theme.js';
    import { getCurrentUser, logout } from './auth.js';
    import { ref, get } from 'https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js';
    import { db } from './firebase-init.js';

        initNightMode();

        document.addEventListener('DOMContentLoaded', async () => {
    const cu = getCurrentUser();
    if (!cu) {
        window.location.href = 'login.html';
        return;
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        logout();
        window.location.href = 'login.html';
    });

    // Load user's application data
    try {
        const snapshot = await get(ref(db, `users/${cu.uid}`));
        if (!snapshot.exists()) {
            document.getElementById('content').innerHTML = '<p>Belum mendaftar. <a href="signup.html">Daftar sekarang</a></p>';
            return;
        }
        const user = snapshot.val();
        
        // Show admin link if role is admin
        const adminLink = document.getElementById('adminLink');
        if (adminLink) {
            if (user.role === 'admin') adminLink.style.display = 'inline-block';
            else adminLink.style.display = 'none';
        }
        
        // render timeline with all stages
        const timeline = document.getElementById('timeline');
        const stages = [
            { id: 'berkas', title: 'Pengumpulan Berkas' },
            { id: 'seleksi', title: 'Seleksi Berkas' },
            { id: 'interview', title: 'Interview' },
            { id: 'pengumuman', title: 'Pengumuman Akhir' }
        ];
        
        // Get the current stage from user's status
        const currentStage = user.currentStage || 'berkas';
        const stageStatuses = user.stageStatuses || {};

        stages.forEach(stage => {
            const status = stageStatuses[stage.id] || (stage.id === currentStage ? 'pending' : 'pending');
            const li = document.createElement('li');
            li.className = `status-${status}`;
            
            let statusText = status.charAt(0).toUpperCase() + status.slice(1);
            let date = stageStatuses[stage.id + 'Date'] ? new Date(stageStatuses[stage.id + 'Date']).toLocaleString() : '';
            let note = stageStatuses[stage.id + 'Note'] || '';
            
            li.innerHTML = `
                <strong>${stage.title}</strong>
                <div class="meta">Status: ${statusText}</div>
                ${date ? `<div class="meta">Tanggal: ${date}</div>` : ''}
                ${note ? `<p>${note}</p>` : ''}
            `;
            timeline.appendChild(li);
        });
        
        // Hide loading and show timeline
        document.getElementById('loading').style.display = 'none';
        document.getElementById('timeline').style.display = 'block';
    } catch (err) {
        console.error(err);
        document.getElementById('content').innerText = 'Error loading data.';
    }
});
    </script>
</head>
<body>
    <!-- fixed night mode toggle (outside container) -->
    <div class="fixed-night-toggle">
        <button id="nightModeToggle" class="switch" role="switch" aria-checked="false" aria-label="Toggle night mode" title="Toggle night mode">
            <span class="slider" aria-hidden="true">
                <span class="icon icon-moon">üåô</span>
                <span class="icon icon-sun">‚òÄÔ∏è</span>
                <span class="knob" aria-hidden="true"></span>
            </span>
        </button>
    </div>

    <div class="container">
        <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
            <h2>Dashboard Pelamar</h2>
            <div style="display:flex;align-items:center;gap:12px">
                <button id="logoutBtn" class="btn">Logout</button>
                <a href="admin.html" class="btn secondary" style="display:none" id="adminLink">Admin</a>
            </div>
        </header>
        <div id="content">
            <div id="loading" style="text-align:center;padding:20px;">Loading...</div>
            <ul id="timeline" class="timeline" style="display:none"></ul>
        </div>
    </div>
</body>
</html>