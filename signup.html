<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Daftar - Asisten Fisika Lab 2</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" href="favicon-phi.svg" type="image/svg+xml">
    <script type="module" src="firebase-init.js"></script>
    <script type="module" src="theme.js"></script>
    <script type="module">
    import { initNightMode } from './theme.js';
    import { signupApplicant, getCurrentUser } from './auth.js';

        initNightMode();

        document.addEventListener('DOMContentLoaded', () => {
            if (getCurrentUser()) {
                // If logged in already, redirect to home
                window.location.href = 'home.html';
                return;
            }

            const form = document.getElementById('signupForm');
            const progressBar = document.getElementById('uploadProgress');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                const programmingLanguages = [];
                if (fd.get('lang_python')) programmingLanguages.push('Python');
                if (fd.get('lang_matlab')) programmingLanguages.push('MATLAB');
                const researchTitles = [];
                const rt1 = fd.get('researchTitle');
                const rt2 = fd.get('researchTitle2');
                if (rt1) researchTitles.push(rt1);
                if (rt2 && rt2 !== rt1) researchTitles.push(rt2);

                const data = {
                    name: fd.get('name'),
                    nrp: fd.get('nrp'),
                    whatsapp: fd.get('whatsapp'),
                    motivasi: fd.get('motivasi'),
                    prioritas: fd.get('prioritas'),
                    programmingLanguages,
                    researchTitles,
                    penjelasanJudul: fd.get('penjelasanJudul'),
                    password: fd.get('password'),
                    berkasLink: fd.get('berkasLink')
                };
                const berkasLink = data.berkasLink;
                const driveRegex = /https:\/\/drive\.google\.com\/(file\/d\/|open\?|uc\?|drive\/folders\/)/i;
                if (!berkasLink || !driveRegex.test(berkasLink)) { alert('Harap masukkan link Google Drive yang valid'); return; }

                try {
                    progressBar.value = 0;
                    // pass nulls for files (auth.signup will save berkasLink instead)
                    await signupApplicant(data, null, null, (p) => { progressBar.value = p; });
                    progressBar.value = 100;
                    alert('Pendaftaran berhasil. Anda telah login.');
                    window.location.href = 'home.html';
                } catch (err) {
                    if (err.message === 'already-signed-up') {
                        alert('Anda sudah terdaftar. Silakan login.');
                        window.location.href = 'login.html';
                    } else {
                        alert('Gagal mendaftar: ' + err.message);
                    }
                }
            });
        });
    </script>
</head>
<body>
    <!-- fixed night mode toggle (outside container) -->
    <div class="fixed-night-toggle">
        <button id="nightModeToggle" class="switch" role="switch" aria-checked="false" aria-label="Toggle night mode" title="Toggle night mode">
            <span class="slider" aria-hidden="true">
                <span class="icon icon-moon">üåô</span>
                <span class="icon icon-sun">‚òÄÔ∏è</span>
                <span class="knob" aria-hidden="true"></span>
            </span>
        </button>
    </div>

    <div class="auth-wrap">
        <div class="auth-card">
            <div class="auth-logo" aria-hidden="true">üë§</div>
            <h1 class="auth-title">Pendaftaran Asisten Fisika Lab 2</h1>
            <p class="auth-subtitle">Lengkapi formulir berikut untuk mendaftar</p>

            <form id="signupForm" class="auth-form" enctype="multipart/form-data">
                <label class="field">Nama Lengkap
                    <input name="name" class="auth-input" required>
                </label>
                <label class="field">NRP
                    <input name="nrp" class="auth-input" required pattern="\d+" placeholder="contoh: 5026210012">
                </label>
                <label class="field">Nomor WhatsApp
                    <input name="whatsapp" class="auth-input" required placeholder="Contoh: +62812345678">
                </label>
                <label class="field">Motivasi
                    <textarea name="motivasi" class="auth-input" required></textarea>
                </label>

                <label class="field">Skala Prioritas (1-10)
                    <input name="prioritas" class="auth-input" type="number" min="1" max="10" required>
                </label>

                <div class="field-row" style="margin-bottom:10px">
                    <label class="field" style="width:100%">Bahasa Pemrograman yang Dikuasai</label>
                    <div style="display:flex;gap:12px">
                        <label style="font-weight:600">Python <input type="checkbox" name="lang_python" value="1"></label>
                        <label style="font-weight:600">MATLAB <input type="checkbox" name="lang_matlab" value="1"></label>
                    </div>
                </div>

                <label class="field">Judul Praktikum 1 (pilih salah satu)
                    <select name="researchTitle" class="auth-input">
                        <option value="">-- Pilih judul praktikum --</option>
                        <option value="Konstanta Planck">Konstanta Planck</option>
                        <option value="Tetes Minyak Milikan">Tetes Minyak Milikan</option>
                        <option value="Histeresis Ferromagnetik">Histeresis Ferromagnetik</option>
                        <option value="Radioaktivitas dan Pengukuran Paruh Waktu">Radioaktivitas dan Pengukuran Paruh Waktu</option>
                        <option value="Percobaan Franck Hertz">Percobaan Franck Hertz</option>
                        <option value="Difraksi Celah Tunggal">Difraksi Celah Tunggal</option>
                        <option value="Determinasi Sudut Brewster">Determinasi Sudut Brewster</option>
                        <option value="Spektrum Cahaya Lampu">Spektrum Cahaya Lampu</option>
                        <option value="Hukum Mersenne">Hukum Mersenne</option>
                        <option value="Cincin Newton">Cincin Newton</option>
                    </select>
                </label>

                <label class="field">Judul Praktikum 2 (opsional)
                    <select name="researchTitle2" class="auth-input">
                        <option value="">-- Pilih judul praktikum (opsional) --</option>
                        <!-- additional options omitted for brevity -->
                    </select>
                </label>

                <label class="field">Penjelasan Judul
                    <textarea name="penjelasanJudul" class="auth-input"></textarea>
                </label>

                <label class="field">Pengumpulan Berkas (Google Drive link)
                    <small style="display:block;margin-top:4px;color:#64748b">Masukkan link Drive yang dapat diakses reviewer</small>
                    <input name="berkasLink" class="auth-input" type="url" placeholder="https://drive.google.com/..." required>
                </label>

                <label class="field">Password
                    <input name="password" class="auth-input" type="password" required>
                </label>

                <p style="margin-top:12px">
                    <button class="btn auth-btn" type="submit">Daftar</button>
                </p>
                <p style="margin-top:8px;text-align:center">
                    <a href="login.html" class="btn secondary" style="width:140px;display:inline-block;text-align:center">Kembali ke Login</a>
                </p>

                <p style="margin-top:12px">
                    <label>Upload progress:</label>
                    <progress id="uploadProgress" max="100" value="0" style="width:100%"></progress>
                </p>
            </form>
        </div>
    </div>
</body>
</html>
