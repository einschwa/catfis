<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Daftar - Asisten Fisika Lab 2</title>
    <link rel="stylesheet" href="style.css">
    <script type="module" src="firebase-init.js"></script>
    <script type="module" src="theme.js"></script>
    <script type="module">
    import { initNightMode } from './theme.js';
    import { signupApplicant, getCurrentUser } from './auth.js';

        initNightMode();

        document.addEventListener('DOMContentLoaded', () => {
            if (getCurrentUser()) {
                // If logged in already, redirect to home
                window.location.href = 'home.html';
                return;
            }

            const form = document.getElementById('signupForm');
            const progressBar = document.getElementById('uploadProgress');
            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                const fd = new FormData(form);
                const programmingLanguages = [];
                if (fd.get('lang_python')) programmingLanguages.push('Python');
                if (fd.get('lang_matlab')) programmingLanguages.push('MATLAB');
                const researchTitles = [];
                const rt1 = fd.get('researchTitle');
                const rt2 = fd.get('researchTitle2');
                if (rt1) researchTitles.push(rt1);
                if (rt2 && rt2 !== rt1) researchTitles.push(rt2);

                const data = {
                    name: fd.get('name'),
                    nrp: fd.get('nrp'),
                    whatsapp: fd.get('whatsapp'),
                    motivasi: fd.get('motivasi'),
                    prioritas: fd.get('prioritas'),
                    programmingLanguages,
                    researchTitles,
                    penjelasanJudul: fd.get('penjelasanJudul'),
                    password: fd.get('password'),
                    berkasLink: fd.get('berkasLink')
                };
                const berkasLink = data.berkasLink;
                const driveRegex = /https:\/\/drive\.google\.com\/(file\/d\/|open\?|uc\?|drive\/folders\/)/i;
                if (!berkasLink || !driveRegex.test(berkasLink)) { alert('Harap masukkan link Google Drive yang valid'); return; }

                try {
                    progressBar.value = 0;
                    // pass nulls for files (auth.signup will save berkasLink instead)
                    await signupApplicant(data, null, null, (p) => { progressBar.value = p; });
                    progressBar.value = 100;
                    alert('Pendaftaran berhasil. Anda telah login.');
                    window.location.href = 'home.html';
                } catch (err) {
                    if (err.message === 'already-signed-up') {
                        alert('Anda sudah terdaftar. Silakan login.');
                        window.location.href = 'login.html';
                    } else {
                        alert('Gagal mendaftar: ' + err.message);
                    }
                }
            });
        });
    </script>
</head>
<body>
    <div class="container">
        <h2>Form Pendaftaran (Asisten Fisika Lab 2)</h2>
        <form id="signupForm" enctype="multipart/form-data">
            <label>Nama
                <input name="name" required>
            </label>
            <label>NRP
                <input name="nrp" required pattern="\d+" placeholder="contoh: 5026210012">
            </label>
            <label>Nomor Whatsapp
                <input name="whatsapp" required placeholder="+628...">
            </label>
            <label>Motivasi
                <textarea name="motivasi" required></textarea>
            </label>
            <label>Skala Prioritas (1-10)
                <input name="prioritas" type="number" min="1" max="10" required>
            </label>

            <div class="field-row">
                <div>
                    <label><input type="checkbox" name="lang_python" value="1"> Python</label>
                </div>
                <div>
                    <label><input type="checkbox" name="lang_matlab" value="1"> MATLAB</label>
                </div>
            </div>

            <div>
                <label>Judul Praktikum 1 (pilih salah satu)
                    <select name="researchTitle">
                        <option value="">-- Pilih judul praktikum --</option>
                        <option value="Konstanta Planck">Konstanta Planck</option>
                        <option value="Tetes Minyak Milikan">Tetes Minyak Milikan</option>
                        <option value="Histeresis Ferromagnetik">Histeresis Ferromagnetik</option>
                        <option value="Radioaktivitas dan Pengukuran Paruh Waktu">Radioaktivitas dan Pengukuran Paruh Waktu</option>
                        <option value="Percobaan Franck Hertz">Percobaan Franck Hertz</option>
                        <option value="Difraksi Celah Tunggal">Difraksi Celah Tunggal</option>
                        <option value="Determinasi Sudut Brewster">Determinasi Sudut Brewster</option>
                        <option value="Spektrum Cahaya Lampu">Spektrum Cahaya Lampu</option>
                        <option value="Hukum Mersenne">Hukum Mersenne</option>
                        <option value="Cincin Newton">Cincin Newton</option>
                    </select>
                </label>
            </div>

            <div>
                <label>Judul Praktikum 2 (opsional)
                    <select name="researchTitle2">
                        <option value="">-- Pilih judul praktikum (opsional) --</option>
                        <option value="Konstanta Planck">Konstanta Planck</option>
                        <option value="Tetes Minyak Milikan">Tetes Minyak Milikan</option>
                        <option value="Histeresis Ferromagnetik">Histeresis Ferromagnetik</option>
                        <option value="Radioaktivitas dan Pengukuran Paruh Waktu">Radioaktivitas dan Pengukuran Paruh Waktu</option>
                        <option value="Percobaan Franck Hertz">Percobaan Franck Hertz</option>
                        <option value="Difraksi Celah Tunggal">Difraksi Celah Tunggal</option>
                        <option value="Determinasi Sudut Brewster">Determinasi Sudut Brewster</option>
                        <option value="Spektrum Cahaya Lampu">Spektrum Cahaya Lampu</option>
                        <option value="Hukum Mersenne">Hukum Mersenne</option>
                        <option value="Cincin Newton">Cincin Newton</option>
                    </select>
                </label>
            </div>

            <label>Penjelasan Judul
                <textarea name="penjelasanJudul"></textarea>
            </label>

            <label>Pengumpulan Berkas (Google Drive link)
                <input name="berkasLink" type="url" placeholder="https://drive.google.com/â€¦" required>
                <small>Masukkan link Google Drive (pastikan link dapat diakses oleh reviewer)</small>
            </label>

            <label>Password (untuk demo)
                <input name="password" type="password" required>
            </label>

            <p>
                <button class="btn" type="submit">Daftar</button>
                <a href="login.html" class="btn secondary">Kembali ke Login</a>
            </p>

            <p>
                <label>Upload progress:</label>
                <progress id="uploadProgress" max="100" value="0" style="width:100%"></progress>
            </p>

            <p style="margin-top:12px">
                <label><input id="nightModeToggle" type="checkbox"> Night Mode</label>
            </p>
        </form>
    </div>
</body>
</html>